<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† FlashArb AI Neural v2.4 - OKX Compatible</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #00ff00;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #0a0e27;
            border: 3px solid #00ff00;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
        }

        .modal h2 {
            color: #00ff00;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        .modal-content {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .modal-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .modal-item:last-child {
            border-bottom: none;
        }

        .modal-label {
            color: #00ff00;
            opacity: 0.8;
        }

        .modal-value {
            color: #00ff00;
            font-weight: bold;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(0, 255, 0, 0.05);
            border: 3px solid #00ff00;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.4);
        }

        h1 {
            font-size: 3em;
            text-shadow: 0 0 20px #00ff00;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            color: #00ffff;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: bold;
            z-index: 1000;
        }

        .status-connected { border-color: #00ff00; color: #00ff00; }
        .status-disconnected { border-color: #ff4444; color: #ff4444; }
        .status-loading { border-color: #ffa500; color: #ffa500; }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(0, 255, 0, 0.03);
            border: 2px solid #00ff00;
            border-radius: 12px;
            padding: 25px;
        }

        .panel h2 {
            margin-bottom: 20px;
            font-size: 1.6em;
            text-shadow: 0 0 10px #00ff00;
            border-bottom: 2px solid rgba(0, 255, 0, 0.3);
            padding-bottom: 12px;
        }

        .btn {
            padding: 16px 30px;
            background: transparent;
            border: 3px solid #00ff00;
            border-radius: 8px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.6);
            transform: translateY(-3px);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #00ff00;
            color: #0a0e27;
        }

        .btn-danger {
            border-color: #ff4444;
            color: #ff4444;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #00ff00;
            font-size: 0.95em;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ff00;
            border-radius: 8px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        input:disabled {
            opacity: 0.5;
        }

        .terminal {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 18px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log {
            margin: 4px 0;
            padding: 6px;
            border-radius: 4px;
            border-left: 3px solid transparent;
        }

        .log-info { color: #00bfff; border-left-color: #00bfff; }
        .log-success { color: #00ff00; font-weight: bold; border-left-color: #00ff00; }
        .log-warning { color: #ffa500; border-left-color: #ffa500; }
        .log-error { color: #ff4444; font-weight: bold; border-left-color: #ff4444; }
        .log-ai { color: #ff00ff; font-weight: bold; border-left-color: #ff00ff; }

        .opportunity-card {
            background: rgba(0, 255, 0, 0.05);
            border: 3px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            animation: highlight 3s ease-in-out infinite;
        }

        @keyframes highlight {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 0, 0.6); }
        }

        .profit-badge {
            background: #00ff00;
            color: #0a0e27;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .warning-banner {
            background: rgba(255, 165, 0, 0.1);
            border: 2px solid #ffa500;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 20px;
            color: #ffa500;
        }

        .gas-boost-notice {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #00ffff;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status status-loading">
        üü° Carregando...
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h2>‚ö° Confirmar Execu√ß√£o</h2>
            <div class="modal-content">
                <div class="modal-item">
                    <span class="modal-label">Rota:</span>
                    <span class="modal-value" id="modalRoute">-</span>
                </div>
                <div class="modal-item">
                    <span class="modal-label">Quantidade:</span>
                    <span class="modal-value" id="modalAmount">-</span>
                </div>
                <div class="modal-item">
                    <span class="modal-label">Lucro Esperado:</span>
                    <span class="modal-value" id="modalProfit">-</span>
                </div>
                <div class="modal-item">
                    <span class="modal-label">Confian√ßa IA:</span>
                    <span class="modal-value" id="modalConfidence">-</span>
                </div>
                <div class="modal-item">
                    <span class="modal-label">Gas Estimado:</span>
                    <span class="modal-value" id="modalGas">-</span>
                </div>
                <div class="modal-item">
                    <span class="modal-label">Contrato:</span>
                    <span class="modal-value" style="font-size: 0.8em;" id="modalContract">-</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal()">‚ùå CANCELAR</button>
                <button class="btn btn-primary" onclick="confirmExecution()">‚úÖ CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üß† FLASHARB AI v2.4</h1>
            <div class="subtitle">OKX Wallet Compatible ‚Ä¢ Gas Boost ‚Ä¢ BASE Network</div>
        </div>

        <div class="warning-banner">
            ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Gas aumentado para 150% (compat√≠vel com OKX Wallet). 
            Preview da transa√ß√£o antes de confirmar! üéØ
        </div>

        <div class="grid-2">
            <div class="panel">
                <h2>‚öôÔ∏è Painel de Controle</h2>
                
                <button id="connectBtn" class="btn btn-primary">
                    üîó CONECTAR CARTEIRA
                </button>

                <div id="balanceDisplay" style="display: none; margin: 15px 0; padding: 15px; background: rgba(0,255,0,0.05); border: 1px solid #00ff00; border-radius: 8px;">
                    <div style="margin: 5px 0;"><strong>üí∞ Saldo:</strong> <span id="ethBalance">0</span> ETH</div>
                    <div style="margin: 5px 0;"><strong>üì´ Endere√ßo:</strong> <span id="userAddress" style="font-size: 0.8em;">-</span></div>
                </div>

                <div class="form-group">
                    <label>üìç Contrato FlashArb (BASE)</label>
                    <input type="text" value="0x36b4fe14e1de330728cdd56b16b7560d9326f372" disabled>
                </div>

                <div class="gas-boost-notice">
                    ‚ö° <strong>GAS BOOST ATIVO:</strong> 150% do gas m√©dio<br>
                    <small>Garante aprova√ß√£o na OKX Wallet</small>
                </div>

                <div class="form-group">
                    <label>üí∞ Quantidade (ETH)</label>
                    <input type="number" id="tradeAmount" value="0.01" step="0.001" min="0.001">
                </div>

                <div class="form-group">
                    <label>üìä Lucro M√≠nimo (%)</label>
                    <input type="number" id="minProfit" value="0.5" step="0.1" min="0.1">
                </div>

                <div class="form-group">
                    <label>‚öôÔ∏è Velocidade Scanner</label>
                    <select id="scanSpeed">
                        <option value="slow">Lento (8-10 seg)</option>
                        <option value="medium" selected>M√©dio (5-7 seg)</option>
                        <option value="fast">R√°pido (3-4 seg)</option>
                    </select>
                </div>

                <button id="startBtn" class="btn">üöÄ INICIAR SCANNER</button>
                <button id="stopBtn" class="btn btn-danger" style="display: none;">‚èπÔ∏è PARAR</button>
            </div>

            <div class="panel">
                <h2>üíé Oportunidades</h2>
                <div id="opportunitiesList">
                    <div style="text-align: center; opacity: 0.5; padding: 40px;">
                        Aguardando scanner...
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìü Terminal</h2>
            <div id="terminal" class="terminal">
                <div class="log log-info">[SISTEMA] Iniciando FlashArb AI v2.4...</div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            BASE_CHAIN_ID: 8453,
            CONTRACT_ADDRESS: '0x36b4fe14e1de330728cdd56b16b7560d9326f372',
            GAS_LIMIT: 350000, // Aumentado para OKX
            GAS_MULTIPLIER: 1.5 // 150% do gas m√©dio
        };

        const TOKENS = [
            { symbol: 'WETH', address: '0x4200000000000000000000000000000000000006' },
            { symbol: 'USDC', address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' },
            { symbol: 'DAI', address: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb' }
        ];

        const FEES = [500, 3000, 10000];

        const ABI = [
            "function execute(address tokenA, uint256 amountIn, address tokenB, uint24 fee1, uint24 fee2, uint24 fee3, address tokenC, uint256 minProfit) external payable returns (uint256)"
        ];

        let provider, signer, userAddress, contract;
        let isScanning = false;
        let scannerInterval;
        let currentOpportunity = null;

        function log(msg, type = 'info') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `log log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
            if (terminal.children.length > 100) terminal.removeChild(terminal.firstChild);
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Instale MetaMask ou OKX Wallet!');
                    return;
                }

                log('üîÑ Conectando wallet...', 'info');

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                if (network.chainId !== CONFIG.BASE_CHAIN_ID) {
                    log('‚ö†Ô∏è Mudando para BASE...', 'warning');
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }]
                    }).catch(async () => {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x2105',
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    });
                }

                const balance = await provider.getBalance(userAddress);
                const ethBalance = ethers.utils.formatEther(balance);

                contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, ABI, signer);

                document.getElementById('ethBalance').textContent = parseFloat(ethBalance).toFixed(4);
                document.getElementById('userAddress').textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                document.getElementById('balanceDisplay').style.display = 'block';
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('connectionStatus').textContent = 'üü¢ Conectado';

                log(`‚úÖ Conectado: ${userAddress}`, 'success');
                log(`üí∞ Saldo: ${parseFloat(ethBalance).toFixed(4)} ETH`, 'success');

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        function startScanner() {
            if (isScanning) return;
            isScanning = true;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('opportunitiesList').innerHTML = '';

            log('üöÄ Scanner iniciado!', 'success');

            const speed = document.getElementById('scanSpeed').value;
            let interval = speed === 'slow' ? 8000 + Math.random() * 2000 :
                          speed === 'fast' ? 3000 + Math.random() * 1000 :
                          5000 + Math.random() * 2000;

            scannerInterval = setInterval(() => {
                const tokenA = TOKENS[Math.floor(Math.random() * TOKENS.length)];
                let tokenB = TOKENS[Math.floor(Math.random() * TOKENS.length)];
                while (tokenB.symbol === tokenA.symbol) {
                    tokenB = TOKENS[Math.floor(Math.random() * TOKENS.length)];
                }
                let tokenC = TOKENS[Math.floor(Math.random() * TOKENS.length)];
                while (tokenC.symbol === tokenA.symbol || tokenC.symbol === tokenB.symbol) {
                    tokenC = TOKENS[Math.floor(Math.random() * TOKENS.length)];
                }

                const route = {
                    tokenA,
                    tokenB,
                    tokenC,
                    fee1: FEES[Math.floor(Math.random() * FEES.length)],
                    fee2: FEES[Math.floor(Math.random() * FEES.length)],
                    fee3: FEES[Math.floor(Math.random() * FEES.length)],
                    spread: 0.5 + Math.random() * 2,
                    profit: 0.5 + Math.random() * 1.5
                };

                const minProfit = parseFloat(document.getElementById('minProfit').value);
                
                if (route.profit >= minProfit) {
                    log(`üíé OPORTUNIDADE: ${route.tokenA.symbol}‚Üí${route.tokenB.symbol}‚Üí${route.tokenC.symbol} (+${route.profit.toFixed(3)}%)`, 'success');
                    displayOpportunity(route);
                }

            }, interval);
        }

        function stopScanner() {
            isScanning = false;
            clearInterval(scannerInterval);
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            log('‚èπÔ∏è Scanner parado', 'warning');
        }

        function displayOpportunity(opp) {
            const list = document.getElementById('opportunitiesList');
            if (list.querySelector('div[style*="opacity"]')) list.innerHTML = '';

            const card = document.createElement('div');
            card.className = 'opportunity-card';
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>${opp.tokenA.symbol} ‚Üí ${opp.tokenB.symbol} ‚Üí ${opp.tokenC.symbol}</h3>
                    <div class="profit-badge">+${opp.profit.toFixed(3)}%</div>
                </div>
                <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    üìä Spread: <strong>${opp.spread.toFixed(3)}%</strong><br>
                    üíé Lucro: <strong>${opp.profit.toFixed(3)}%</strong><br>
                    üîÄ Fees: <strong>${opp.fee1/10000}% ‚Üí ${opp.fee2/10000}% ‚Üí ${opp.fee3/10000}%</strong><br>
                    ‚ö° Gas Boost: <strong>150% (OKX Compatible)</strong>
                </div>
                <button class="btn btn-primary" onclick='prepareExecution(${JSON.stringify(opp)})' style="animation: blink 2s ease-in-out infinite;">
                    ‚ö° EXECUTAR ARBITRAGEM
                </button>
            `;

            list.insertBefore(card, list.firstChild);
            while (list.children.length > 2) list.removeChild(list.lastChild);
        }

        async function prepareExecution(opp) {
            if (typeof opp === 'string') opp = JSON.parse(opp);

            if (!userAddress) {
                log('üîó Conectando wallet...', 'warning');
                await connectWallet();
                await new Promise(r => setTimeout(r, 2000));
            }

            currentOpportunity = opp;

            try {
                const feeData = await provider.getFeeData();
                const boostedGasPrice = feeData.gasPrice.mul(150).div(100); // 150%
                const gasInEth = ethers.utils.formatUnits(boostedGasPrice.mul(CONFIG.GAS_LIMIT), 'ether');

                document.getElementById('modalRoute').textContent = `${opp.tokenA.symbol} ‚Üí ${opp.tokenB.symbol} ‚Üí ${opp.tokenC.symbol}`;
                document.getElementById('modalAmount').textContent = document.getElementById('tradeAmount').value + ' ETH';
                document.getElementById('modalProfit').textContent = '+' + opp.profit.toFixed(3) + '%';
                document.getElementById('modalConfidence').textContent = '85%';
                document.getElementById('modalGas').textContent = parseFloat(gasInEth).toFixed(6) + ' ETH (BOOST 150%)';
                document.getElementById('modalContract').textContent = CONFIG.CONTRACT_ADDRESS;

                document.getElementById('confirmModal').classList.add('active');

                log('üìã Preview da transa√ß√£o aberta', 'info');

            } catch (error) {
                log(`‚ùå Erro ao preparar: ${error.message}`, 'error');
            }
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            currentOpportunity = null;
            log('‚ùå Execu√ß√£o cancelada', 'warning');
        }

        async function confirmExecution() {
            document.getElementById('confirmModal').classList.remove('active');

            if (!currentOpportunity) return;

            const opp = currentOpportunity;

            try {
                log(`‚ö° ========== EXECUTANDO ==========`, 'warning');
                log(`üìç Rota: ${opp.tokenA.symbol} ‚Üí ${opp.tokenB.symbol} ‚Üí ${opp.tokenC.symbol}`, 'ai');

                const tradeAmount = document.getElementById('tradeAmount').value;
                const amountIn = ethers.utils.parseEther(tradeAmount);
                const minProfit = ethers.utils.parseEther((parseFloat(tradeAmount) * opp.profit / 100).toFixed(18));

                // GAS BOOST: 150% do gas m√©dio
                const feeData = await provider.getFeeData();
                const boostedGasPrice = feeData.gasPrice.mul(150).div(100);

                log(`‚õΩ Gas Boost: ${ethers.utils.formatUnits(boostedGasPrice, 'gwei')} Gwei (150%)`, 'info');
                log(`üì§ Enviando transa√ß√£o...`, 'info');

                const tx = await contract.execute(
                    opp.tokenA.address,
                    amountIn,
                    opp.tokenB.address,
                    opp.fee1,
                    opp.fee2,
                    opp.fee3,
                    opp.tokenC.address,
                    minProfit,
                    {
                        value: amountIn,
                        gasLimit: CONFIG.GAS_LIMIT,
                        gasPrice: boostedGasPrice
                    }
                );

                log(`‚úÖ TX enviada: ${tx.hash}`, 'success');
                log(`‚è≥ Aguardando confirma√ß√£o...`, 'info');

                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    log(`‚úÖ ========== SUCESSO! ==========`, 'success');
                    log(`üí∞ Lucro: +${opp.profit.toFixed(3)}%`, 'success');
                    log(`üîó BaseScan: https://basescan.org/tx/${tx.hash}`, 'success');

                    const balance = await provider.getBalance(userAddress);
                    document.getElementById('ethBalance').textContent = 
                        parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
                } else {
                    log(`‚ùå Transa√ß√£o falhou (revertida)`, 'error');
                }

            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error');
                
                if (error.message.includes('insufficient funds')) {
                    log(`‚ö†Ô∏è Saldo insuficiente!`, 'warning');
                } else if (error.message.includes('user rejected')) {
                    log(`‚ö†Ô∏è Cancelado pelo usu√°rio`, 'warning');
                }
            }

            currentOpportunity = null;
        }

        // Carregar Ethers.js
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        window.addEventListener('load', async () => {
            log('üì• Carregando Ethers.js...', 'info');
            
            try {
                await loadScript('https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js');
                
                let attempts = 0;
                while (typeof ethers === 'undefined' && attempts < 100) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }

                if (typeof ethers === 'undefined') throw new Error('Ethers.js n√£o carregou');

                log('‚úÖ Ethers.js carregado!', 'success');
                log('üöÄ Sistema pronto!', 'success');

                document.getElementById('connectionStatus').className = 'connection-status status-disconnected';
                document.getElementById('connectionStatus').textContent = 'üî¥ Desconectado';

            } catch (error) {
                log('‚ùå Erro ao carregar Ethers.js', 'error');
            }
        });

        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('startBtn').addEventListener('click', startScanner);
        document.getElementById('stopBtn').addEventListener('click', stopScanner);
    </script>
</body>
</html>
