<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flashloan Arbitrage - Arbitrum + Aave</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
        }

        .input-group input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .opportunity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .opportunity-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4facfe;
            cursor: pointer;
            transition: all 0.3s;
        }

        .opportunity-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateX(5px);
        }

        .opportunity-item.excellent {
            border-left-color: #00ff00;
        }

        .opportunity-item.good {
            border-left-color: #ffff00;
        }

        .opportunity-item.medium {
            border-left-color: #ff9900;
        }

        .profit-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0,255,0,0.3);
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .log-console {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4facfe;
            padding-left: 10px;
        }

        .log-success {
            border-left-color: #00ff00;
        }

        .log-error {
            border-left-color: #ff0000;
        }

        .log-warning {
            border-left-color: #ffff00;
        }

        .neural-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .neural-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            animation: pulse 2s infinite;
        }

        .neural-indicator.active {
            background: #00ff00;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .wallet-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .price-chart {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .dex-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .dex-badge {
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            font-size: 0.85em;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .execution-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .execution-modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-content h3 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Flashloan Arbitrage Bot</h1>
            <p>Arbitrum Network + Aave V3 + Neural Network Analysis</p>
            <div class="status-badge" id="networkStatus">üî¥ Desconectado</div>
        </div>

        <div class="grid">
            <!-- Wallet Connection -->
            <div class="card">
                <h2>üíº Carteira</h2>
                <button class="btn btn-success" id="connectWallet" onclick="connectWallet()">
                    Conectar OKX Wallet
                </button>
                <div class="wallet-info" id="walletInfo" style="display:none;">
                    <div><strong>Endere√ßo:</strong></div>
                    <div id="walletAddress" style="font-size:0.8em;word-break:break-all;"></div>
                    <div style="margin-top:10px;"><strong>Rede:</strong> Arbitrum One</div>
                    <div><strong>Saldo ETH:</strong> <span id="ethBalance">0</span></div>
                </div>
            </div>

            <!-- Neural Network Status -->
            <div class="card">
                <h2>üß† Neural Network AI</h2>
                <div class="neural-status">
                    <div class="neural-indicator" id="neuralIndicator"></div>
                    <span id="neuralStatus">Modelo n√£o carregado</span>
                </div>
                <button class="btn" id="trainBtn" onclick="initNeuralNetwork()">
                    Inicializar AI
                </button>
                <div style="margin-top:15px;font-size:0.9em;">
                    <div>Precis√£o: <strong id="aiAccuracy">0%</strong></div>
                    <div>Oportunidades analisadas: <strong id="aiAnalyzed">0</strong></div>
                </div>
            </div>

            <!-- Contract Info -->
            <div class="card">
                <h2>üìú Contrato Flashloan</h2>
                <div class="input-group">
                    <label>Endere√ßo do Contrato:</label>
                    <input type="text" id="contractAddress" value="0xc7cb7192953d3db51fe27cc577a7cf689ac3eed3" readonly>
                </div>
                <button class="btn" onclick="verifyContract()">Verificar Contrato</button>
                <div id="contractStatus" style="margin-top:10px;font-size:0.9em;"></div>
            </div>
        </div>

        <div class="grid">
            <!-- DEX Monitoring -->
            <div class="card">
                <h2>üîÑ DEXs Monitoradas</h2>
                <div class="dex-list">
                    <div class="dex-badge">Uniswap V3</div>
                    <div class="dex-badge">SushiSwap</div>
                    <div class="dex-badge">Camelot</div>
                    <div class="dex-badge">Trader Joe</div>
                    <div class="dex-badge">Balancer</div>
                    <div class="dex-badge">Curve</div>
                </div>
                <div style="margin-top:15px;">
                    <button class="btn" onclick="startMonitoring()" id="monitorBtn">
                        Iniciar Monitoramento
                    </button>
                    <button class="btn btn-danger" onclick="stopMonitoring()" id="stopBtn" disabled>
                        Parar
                    </button>
                </div>
                <div style="margin-top:15px;font-size:0.9em;">
                    Status: <strong id="monitorStatus">Inativo</strong>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>üìä Estat√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Oportunidades</div>
                        <div class="stat-value" id="totalOpportunities">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Executadas</div>
                        <div class="stat-value" id="executedTrades">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Lucro Total</div>
                        <div class="stat-value" id="totalProfit">$0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Taxa Sucesso</div>
                        <div class="stat-value" id="successRate">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opportunities -->
        <div class="card">
            <h2>‚ö° Oportunidades de Arbitragem (AI Analysis)</h2>
            <div class="opportunity-list" id="opportunityList">
                <p style="text-align:center;opacity:0.7;">Aguardando oportunidades...</p>
            </div>
        </div>

        <!-- Price Chart -->
        <div class="card">
            <h2>üìà Gr√°fico de Pre√ßos</h2>
            <div class="price-chart">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- Console Log -->
        <div class="card">
            <h2>üñ•Ô∏è Console de Eventos</h2>
            <div class="log-console" id="logConsole">
                <div class="log-entry">Sistema inicializado. Aguardando conex√£o...</div>
            </div>
        </div>
    </div>

    <!-- Execution Modal -->
    <div class="execution-modal" id="executionModal">
        <div class="modal-content">
            <h3>üöÄ Executando Transa√ß√£o</h3>
            <p id="modalMessage">Preparando flashloan...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p style="font-size:0.9em;opacity:0.8;margin-top:10px;">
                Aguardando aprova√ß√£o na OKX Wallet...
            </p>
        </div>
    </div>

    <script>
        // ============= CONFIGURA√á√ïES =============
        const CONFIG = {
            ARBITRUM_CHAIN_ID: '0xa4b1', // 42161
            ARBITRUM_RPC: 'https://arb1.arbitrum.io/rpc',
            AAVE_POOL: '0x794a61358D6845594F94dc1DB02A252b5b4814aD',
            CONTRACT_ADDRESS: '0xc7cb7192953d3db51fe27cc577a7cf689ac3eed3',
            
            // DEX Routers na Arbitrum
            ROUTERS: {
                UNISWAP_V3: '0xE592427A0AEce92De3Edee1F18E0157C05861564',
                SUSHISWAP: '0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506',
                CAMELOT: '0xc873fEcbd354f5A56E00E710B90EF4201db2448d',
                TRADER_JOE: '0xb4315e873dBcf96Ffd0acd8EA43f689D8c20fB30',
                BALANCER: '0xBA12222222228d8Ba445958a75a0704d566BF2C8',
                CURVE: '0x7544Fe3d184b6B55D6B36c3FCA1157eE0Ba30287'
            },
            
            // Tokens principais
            TOKENS: {
                WETH: '0x82aF49447D8a07e3bd95BD0d56f35241523fBab1',
                USDC: '0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8',
                USDT: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',
                DAI: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1',
                WBTC: '0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f'
            },
            
            MIN_PROFIT_USD: 10, // M√≠nimo $10 de lucro
            GAS_LIMIT: 500000,
            SCAN_INTERVAL: 3000 // 3 segundos
        };

        // ============= VARI√ÅVEIS GLOBAIS =============
        let provider;
        let signer;
        let walletAddress;
        let contract;
        let neuralModel;
        let monitoringInterval;
        let priceChart;
        
        const stats = {
            opportunities: 0,
            executed: 0,
            totalProfit: 0,
            analyzed: 0
        };

        // ============= CONEX√ÉO WALLET =============
        async function connectWallet() {
            try {
                addLog('Conectando √† OKX Wallet...', 'info');
                
                if (typeof window.okxwallet === 'undefined') {
                    alert('OKX Wallet n√£o detectada! Por favor, instale a extens√£o OKX Wallet.');
                    addLog('‚ùå OKX Wallet n√£o encontrada', 'error');
                    return;
                }

                // Solicitar contas
                const accounts = await window.okxwallet.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                walletAddress = accounts[0];
                
                // Criar provider
                provider = new ethers.providers.Web3Provider(window.okxwallet);
                signer = provider.getSigner();
                
                // Verificar rede
                const network = await provider.getNetwork();
                if (network.chainId !== 42161) {
                    await switchToArbitrum();
                }
                
                // Atualizar UI
                document.getElementById('walletAddress').textContent = walletAddress;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectWallet').textContent = '‚úÖ Conectado';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('networkStatus').innerHTML = 'üü¢ Arbitrum Conectado';
                
                // Obter saldo
                await updateBalance();
                
                // Inicializar contrato
                initContract();
                
                addLog(`‚úÖ Wallet conectada: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`, 'success');
                
            } catch (error) {
                console.error('Erro ao conectar wallet:', error);
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function switchToArbitrum() {
            try {
                await window.okxwallet.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.ARBITRUM_CHAIN_ID }],
                });
            } catch (switchError) {
                // Chain n√£o adicionada, vamos adicionar
                if (switchError.code === 4902) {
                    await window.okxwallet.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CONFIG.ARBITRUM_CHAIN_ID,
                            chainName: 'Arbitrum One',
                            nativeCurrency: {
                                name: 'ETH',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: [CONFIG.ARBITRUM_RPC],
                            blockExplorerUrls: ['https://arbiscan.io/']
                        }],
                    });
                }
            }
        }

        async function updateBalance() {
            const balance = await provider.getBalance(walletAddress);
            const ethBalance = ethers.utils.formatEther(balance);
            document.getElementById('ethBalance').textContent = parseFloat(ethBalance).toFixed(4) + ' ETH';
        }

        // ============= INICIALIZA√á√ÉO DO CONTRATO =============
        function initContract() {
            const ABI = [
                "function startFlashloan(address token, uint256 amount, bytes calldata params) external",
                "function getBalance(address token) external view returns (uint256)",
                "function withdraw(address token) external",
                "event Profit(uint256 amount)"
            ];
            
            contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, ABI, signer);
            addLog('üìú Contrato inicializado', 'success');
        }

        async function verifyContract() {
            if (!provider) {
                alert('Conecte sua wallet primeiro!');
                return;
            }
            
            try {
                const code = await provider.getCode(CONFIG.CONTRACT_ADDRESS);
                if (code === '0x') {
                    document.getElementById('contractStatus').innerHTML = 
                        '<span style="color:#ff6b6b;">‚ùå Contrato n√£o encontrado neste endere√ßo</span>';
                    addLog('‚ùå Contrato n√£o encontrado', 'error');
                } else {
                    document.getElementById('contractStatus').innerHTML = 
                        '<span style="color:#51cf66;">‚úÖ Contrato verificado e ativo</span>';
                    addLog('‚úÖ Contrato verificado', 'success');
                }
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // ============= NEURAL NETWORK AI =============
        async function initNeuralNetwork() {
            try {
                addLog('üß† Inicializando Rede Neural...', 'info');
                document.getElementById('neuralStatus').textContent = 'Treinando modelo...';
                
                // Criar modelo
                neuralModel = tf.sequential({
                    layers: [
                        tf.layers.dense({ inputShape: [6], units: 64, activation: 'relu' }),
                        tf.layers.dropout({ rate: 0.2 }),
                        tf.layers.dense({ units: 32, activation: 'relu' }),
                        tf.layers.dropout({ rate: 0.2 }),
                        tf.layers.dense({ units: 16, activation: 'relu' }),
                        tf.layers.dense({ units: 1, activation: 'sigmoid' })
                    ]
                });
                
                neuralModel.compile({
                    optimizer: tf.train.adam(0.001),
                    loss: 'binaryCrossentropy',
                    metrics: ['accuracy']
                });
                
                // Gerar dados de treinamento sint√©ticos
                const trainingData = generateTrainingData();
                
                // Treinar
                await neuralModel.fit(trainingData.xs, trainingData.ys, {
                    epochs: 50,
                    batchSize: 32,
                    validationSplit: 0.2,
                    callbacks: {
                        onEpochEnd: (epoch, logs) => {
                            if (epoch % 10 === 0) {
                                const accuracy = (logs.acc * 100).toFixed(2);
                                document.getElementById('aiAccuracy').textContent = accuracy + '%';
                            }
                        }
                    }
                });
                
                document.getElementById('neuralIndicator').classList.add('active');
                document.getElementById('neuralStatus').textContent = 'Modelo ativo e funcionando';
                document.getElementById('trainBtn').textContent = '‚úÖ AI Ativa';
                document.getElementById('trainBtn').disabled = true;
                
                addLog('‚úÖ Neural Network treinada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro no treinamento:', error);
                addLog(`‚ùå Erro na AI: ${error.message}`, 'error');
            }
        }

        function generateTrainingData() {
            const numSamples = 1000;
            const features = [];
            const labels = [];
            
            for (let i = 0; i < numSamples; i++) {
                // Features: [priceDiff%, volume, gasPrice, liquidityRatio, slippage%, historicalSuccess]
                const priceDiff = Math.random() * 5; // 0-5%
                const volume = Math.random() * 1000000;
                const gasPrice = Math.random() * 100;
                const liquidityRatio = Math.random();
                const slippage = Math.random() * 2;
                const historicalSuccess = Math.random();
                
                features.push([priceDiff, volume/1000000, gasPrice/100, liquidityRatio, slippage/2, historicalSuccess]);
                
                // Label: profitable se priceDiff > 0.5% e slippage < 1%
                const profitable = (priceDiff > 0.5 && slippage < 1 && volume > 100000) ? 1 : 0;
                labels.push([profitable]);
            }
            
            return {
                xs: tf.tensor2d(features),
                ys: tf.tensor2d(labels)
            };
        }

        async function analyzeOpportunityWithAI(opportunity) {
            if (!neuralModel) return 0.5;
            
            try {
                const features = tf.tensor2d([[
                    opportunity.profitPercent / 5,
                    opportunity.volume / 1000000,
                    opportunity.gasEstimate / 100,
                    opportunity.liquidity,
                    opportunity.slippage / 2,
                    0.7 // historical success placeholder
                ]]);
                
                const prediction = await neuralModel.predict(features).data();
                stats.analyzed++;
                document.getElementById('aiAnalyzed').textContent = stats.analyzed;
                
                return prediction[0];
                
            } catch (error) {
                console.error('Erro na an√°lise AI:', error);
                return 0.5;
            }
        }

        // ============= MONITORAMENTO DE PRE√áOS =============
        async function startMonitoring() {
            if (!walletAddress) {
                alert('Conecte sua wallet primeiro!');
                return;
            }
            
            if (!neuralModel) {
                alert('Inicialize a AI primeiro!');
                return;
            }
            
            document.getElementById('monitorBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('monitorStatus').textContent = 'Ativo üîç';
            
            addLog('üîç Monitoramento iniciado', 'success');
            
            monitoringInterval = setInterval(scanOpportunities, CONFIG.SCAN_INTERVAL);
            scanOpportunities(); // Primeira execu√ß√£o imediata
        }

        function stopMonitoring() {
            clearInterval(monitoringInterval);
            document.getElementById('monitorBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('monitorStatus').textContent = 'Inativo';
            addLog('‚è∏Ô∏è Monitoramento pausado', 'warning');
        }

        async function scanOpportunities() {
            try {
                // Simular scan de m√∫ltiplas DEXs
                const opportunities = await Promise.all([
                    fetchPriceFromDEX('Uniswap', CONFIG.TOKENS.WETH, CONFIG.TOKENS.USDC),
                    fetchPriceFromDEX('SushiSwap', CONFIG.TOKENS.WETH, CONFIG.TOKENS.USDC),
                    fetchPriceFromDEX('Camelot', CONFIG.TOKENS.WETH, CONFIG.TOKENS.USDC),
                    fetchPriceFromDEX('Trader Joe', CONFIG.TOKENS.WETH, CONFIG.TOKENS.USDC)
                ]);
                
                // Analisar diferen√ßas de pre√ßo
                for (let i = 0; i < opportunities.length; i++) {
                    for (let j = i + 1; j < opportunities.length; j++) {
                        const opp = calculateArbitrageOpportunity(
                            opportunities[i],
                            opportunities[j]
                        );
                        
                        if (opp && opp.profitUSD >= CONFIG.MIN_PROFIT_USD) {
                            // Analisar com AI
                            const aiScore = await analyzeOpportunityWithAI(opp);
                            opp.aiScore = aiScore;
                            
                            if (aiScore > 0.7) { // AI confiante
                                displayOpportunity(opp);
                                stats.opportunities++;
                                document.getElementById('totalOpportunities').textContent = stats.opportunities;
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Erro no scan:', error);
            }
        }

        async function fetchPriceFromDEX(dexName, tokenIn, tokenOut) {
            // Simular fetch de pre√ßo real (em produ√ß√£o, usar APIs reais)
            const basePrice = 2000 + Math.random() * 100; // ETH/USDC
            const variation = (Math.random() - 0.5) * 10; // ¬±0.5%
            
            return {
                dex: dexName,
                tokenIn,
                tokenOut,
                price: basePrice + variation,
                volume: Math.random() * 1000000 + 100000,
                liquidity: Math.random() * 0.5 + 0.5,
                gasEstimate: Math.random() * 50 + 20
            };
        }

        function calculateArbitrageOpportunity(buy, sell) {
            const priceDiff = sell.price - buy.price;
            const profitPercent = (priceDiff / buy.price) * 100;
            
            if (profitPercent <= 0.2) return null; // M√≠nimo 0.2%
            
            const amount = 1; // 1 ETH
            const profitUSD = priceDiff * amount;
            const gasEstimate = (buy.gasEstimate + sell.gasEstimate) / 2;
            const slippage = Math.random() * 1.5; // 0-1.5%
            
            return {
                buyDEX: buy.dex,
                sellDEX: sell.dex,
                tokenIn: buy.tokenIn,
                tokenOut: buy.tokenOut,
                buyPrice: buy.price,
                sellPrice: sell.price,
                profitPercent,
                profitUSD,
                amount,
                volume: Math.min(buy.volume, sell.volume),
                liquidity: Math.min(buy.liquidity, sell.liquidity),
                gasEstimate,
                slippage,
                timestamp: Date.now()
            };
        }

        function displayOpportunity(opp) {
            const list = document.getElementById('opportunityList');
            
            // Remover mensagem inicial
            if (list.children.length === 1 && list.children[0].tagName === 'P') {
                list.innerHTML = '';
            }
            
            const className = opp.aiScore > 0.85 ? 'excellent' : opp.aiScore > 0.75 ? 'good' : 'medium';
            
            const item = document.createElement('div');
            item.className = `opportunity-item ${className}`;
            item.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <strong>${opp.buyDEX} ‚Üí ${opp.sellDEX}</strong>
                        <div style="font-size:0.9em;opacity:0.8;margin-top:5px;">
                            Comprar: $${opp.buyPrice.toFixed(2)} | Vender: $${opp.sellPrice.toFixed(2)}
                        </div>
                        <div style="font-size:0.85em;margin-top:5px;">
                            AI Score: <strong>${(opp.aiScore * 100).toFixed(1)}%</strong> | 
                            Slippage: ${opp.slippage.toFixed(2)}%
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="profit-badge">+$${opp.profitUSD.toFixed(2)}</div>
                        <div style="font-size:0.85em;margin-top:5px;">
                            ${opp.profitPercent.toFixed(2)}%
                        </div>
                        <button class="btn" style="margin-top:10px;padding:8px 20px;" 
                                onclick='executeArbitrage(${JSON.stringify(opp)})'>
                            Executar
                        </button>
                    </div>
                </div>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // Limitar a 10 oportunidades
            if (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
            
            addLog(`üí∞ Nova oportunidade: +$${opp.profitUSD.toFixed(2)} (${opp.buyDEX}‚Üí${opp.sellDEX})`, 'success');
        }

        // ============= EXECU√á√ÉO DE ARBITRAGEM =============
        async function executeArbitrage(oppString) {
            const opp = typeof oppString === 'string' ? JSON.parse(oppString) : oppString;
            
            if (!contract) {
                alert('Contrato n√£o inicializado!');
                return;
            }
            
            try {
                // Mostrar modal
                document.getElementById('executionModal').classList.add('active');
                document.getElementById('modalMessage').textContent = 'Preparando flashloan...';
                updateProgress(10);
                
                addLog(`üöÄ Iniciando arbitragem: ${opp.buyDEX} ‚Üí ${opp.sellDEX}`, 'info');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(30);
                document.getElementById('modalMessage').textContent = 'Encodando par√¢metros...';
                
                // Encode parameters
                const arbParams = {
                    router1: CONFIG.ROUTERS[opp.buyDEX.toUpperCase().replace(' ', '_')] || CONFIG.ROUTERS.UNISWAP_V3,
                    router2: CONFIG.ROUTERS[opp.sellDEX.toUpperCase().replace(' ', '_')] || CONFIG.ROUTERS.SUSHISWAP,
                    tokenIn: opp.tokenIn,
                    tokenOut: opp.tokenOut,
                    minProfit: ethers.utils.parseUnits(CONFIG.MIN_PROFIT_USD.toString(), 6) // USDC tem 6 decimais
                };
                
                const encodedParams = ethers.utils.defaultAbiCoder.encode(
                    ['address', 'address', 'address', 'address', 'uint256'],
                    [arbParams.router1, arbParams.router2, arbParams.tokenIn, arbParams.tokenOut, arbParams.minProfit]
                );
                
                updateProgress(50);
                document.getElementById('modalMessage').textContent = 'Calculando valor do flashloan...';
                
                const flashloanAmount = ethers.utils.parseEther(opp.amount.toString());
                
                updateProgress(70);
                document.getElementById('modalMessage').textContent = '‚ö†Ô∏è Aprovar transa√ß√£o na OKX Wallet!';
                
                addLog('‚è≥ Aguardando aprova√ß√£o na wallet...', 'warning');
                
                // Executar transa√ß√£o
                const tx = await contract.startFlashloan(
                    opp.tokenIn,
                    flashloanAmount,
                    encodedParams,
                    {
                        gasLimit: CONFIG.GAS_LIMIT
                    }
                );
                
                updateProgress(85);
                document.getElementById('modalMessage').textContent = 'Transa√ß√£o enviada! Aguardando confirma√ß√£o...';
                addLog(`üì§ TX Hash: ${tx.hash}`, 'info');
                
                // Aguardar confirma√ß√£o
                const receipt = await tx.wait();
                
                updateProgress(100);
                document.getElementById('modalMessage').textContent = '‚úÖ Arbitragem executada com sucesso!';
                
                stats.executed++;
                stats.totalProfit += opp.profitUSD;
                
                document.getElementById('executedTrades').textContent = stats.executed;
                document.getElementById('totalProfit').textContent = '$' + stats.totalProfit.toFixed(2);
                
                if (stats.opportunities > 0) {
                    const rate = (stats.executed / stats.opportunities * 100).toFixed(1);
                    document.getElementById('successRate').textContent = rate + '%';
                }
                
                addLog(`‚úÖ Sucesso! Lucro: $${opp.profitUSD.toFixed(2)}`, 'success');
                addLog(`üîó https://arbiscan.io/tx/${tx.hash}`, 'info');
                
                // Fechar modal ap√≥s 3 segundos
                setTimeout(() => {
                    document.getElementById('executionModal').classList.remove('active');
                    updateProgress(0);
                }, 3000);
                
                // Atualizar saldo
                await updateBalance();
                
            } catch (error) {
                console.error('Erro na execu√ß√£o:', error);
                document.getElementById('modalMessage').textContent = '‚ùå Erro na execu√ß√£o';
                addLog(`‚ùå Erro: ${error.message}`, 'error');
                
                setTimeout(() => {
                    document.getElementById('executionModal').classList.remove('active');
                    updateProgress(0);
                }, 3000);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // ============= GR√ÅFICO =============
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ETH/USDC Spread',
                        data: [],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // ============= LOG CONSOLE =============
        function addLog(message, type = 'info') {
            const console = document.getElementById('logConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="opacity:0.6;">[${timestamp}]</span> ${message}`;
            
            console.insertBefore(entry, console.firstChild);
            
            // Limitar a 50 entradas
            if (console.children.length > 50) {
                console.removeChild(console.lastChild);
            }
        }

        // ============= INICIALIZA√á√ÉO =============
        window.addEventListener('load', () => {
            addLog('üéØ Sistema carregado. Conecte sua wallet para come√ßar.', 'info');
            initChart();
            
            // Auto-detect OKX Wallet
            if (typeof window.okxwallet !== 'undefined') {
                addLog('‚úÖ OKX Wallet detectada', 'success');
            } else {
                addLog('‚ö†Ô∏è OKX Wallet n√£o detectada. Instale a extens√£o.', 'warning');
            }
        });
    </script>
</body>
</html>
